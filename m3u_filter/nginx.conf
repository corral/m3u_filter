worker_processes 1;
events { worker_connections 1024; }

http {
    include       mime.types;
    default_type  application/octet-stream;

    server {
        listen 8080;

        location /filtrar {
            content_by_lua_block {
                -- Leer par√°metros o variables del Add-on
                local args = ngx.req.get_uri_args()
                local m3u_url = args.m3u or os.getenv("M3U_URL") or ""
                local filtro_group = args.group or os.getenv("GROUP_FILTER") or "ES|"
                filtro_group = filtro_group:lower()

                local http = require "resty.http"
                local client = http.new()
                local res, err = client:request_uri(m3u_url, { method="GET", keepalive=false })

                ngx.header["Content-Type"] = "audio/x-mpegurl"
                ngx.say("#EXTM3U")

                if not res then
                    ngx.say("# Error: no se pudo obtener la lista")
                    return
                end

                local last_extinf = nil

                for line in res.body:gmatch("[^\r\n]+") do
                    if line:sub(1,7) == "#EXTINF" then
                        last_extinf = line
                    elseif last_extinf then
                        local bloque = last_extinf .. "\n" .. line .. "\n"
                        local group = last_extinf:match('group%-title="([^"]+)"') or ""
                        group = group:lower()
                        if filtro_group == "" or group:find(filtro_group, 1, true) then
                            ngx.print(bloque)
                        end
                        last_extinf = nil
                    end
                end
            }
        }
    }
}
